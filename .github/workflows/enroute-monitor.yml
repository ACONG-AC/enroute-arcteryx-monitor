name: Enroute Arc'teryx Stock Monitor

on:
  workflow_dispatch: {}
  schedule:
    - cron: "*/11 * * * *"

permissions:
  contents: write

concurrency:
  group: enroute-monitor
  cancel-in-progress: true   # 避免并发运行互相抢推送

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      PYTHONUNBUFFERED: "1"
      NOTIFY_ON_NO_CHANGE: "false"
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

    steps:
      - name: Checkout main with full history
        uses: actions/checkout@v4
        with:
          ref: main            # 确保在 main 分支工作
          fetch-depth: 0       # 拿到完整历史，支持 rebase
          persist-credentials: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install deps (pip)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Playwright browsers & system deps
        run: |
          python -m playwright install chromium
          python -m playwright install-deps

      - name: Run monitor (with retries)
        shell: bash
        run: |
          set -euo pipefail
          tries=3
          for i in $(seq 1 $tries); do
            echo "Attempt $i/$tries..."
            if python monitor_enroute_arcteryx.py; then
              echo "Run succeeded."
              exit 0
            fi
            echo "Attempt $i failed. Sleeping $(( i * 20 ))s before retry..."
            sleep $(( i * 20 ))
          done
          echo "All attempts failed."
          exit 1

      - name: Commit snapshot if changed (rebase & retry & lease)
        if: always()
        shell: bash
        run: |
          set -euo pipefail

          # 只有 snapshot.json 变化时才继续
          if ! git status --porcelain | grep -q "snapshot.json"; then
            echo "No snapshot changes."
            exit 0
          fi

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # 确保在 main 分支（checkout@v4 可能是分离头指针场景）
          git checkout -B main

          # 同步远端最新提交
          git fetch --prune origin main

          # 基于远端最新提交做 rebase（避免生成 merge commit）
          git pull --rebase --autostash origin main || true

          # 提交当前快照
          git add snapshot.json
          git commit -m "chore: update snapshot.json [skip ci]" || echo "Nothing to commit after rebase."

          # 推送，失败则重试（应对并发/快速连续提交）
          tries=3
          for i in $(seq 1 $tries); do
            if git push --porcelain origin HEAD:main; then
              echo "Push succeeded."
              exit 0
            fi
            echo "Push rejected. Re-fetch & rebase... attempt $i/$tries"
            git fetch --prune origin main
            git pull --rebase --autostash origin main || true
            sleep $(( i * 5 ))
          done

          echo "Soft push failed after $tries attempts. Trying force-with-lease once..."
          # 最后一招：安全强推（仅当远端未被他人更新时才会覆盖）
          git push --force-with-lease origin HEAD:main

      - name: Upload logs & artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: monitor-logs
          path: |
            **/*.log
            new_map_partial.json
          if-no-files-found: ignore
