name: Enroute Arc'teryx Stock Monitor

on:
  workflow_dispatch: {}
  schedule:
    # 每 11 分钟运行一次（错开整点，避开流量波峰）
    - cron: "*/11 * * * *"

permissions:
  contents: write   # 允许提交 snapshot.json

concurrency:
  group: enroute-monitor
  cancel-in-progress: false

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 45   # 给足总体超时预算
    env:
      PYTHONUNBUFFERED: "1"
      # 关闭“无变更也通知”
      NOTIFY_ON_NO_CHANGE: "false"
      # Webhook 地址（仅在脚本需要发送时使用）
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install deps (pip)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Playwright browsers & system deps
        run: |
          python -m playwright install chromium
          python -m playwright install-deps

      # 运行脚本（保留 3 次重试 + 退避）
      - name: Run monitor (with retries)
        shell: bash
        run: |
          set -euo pipefail
          tries=3
          for i in $(seq 1 $tries); do
            echo "Attempt $i/$tries..."
            if python monitor_enroute_arcteryx.py; then
              echo "Run succeeded."
              exit 0
            fi
            echo "Attempt $i failed. Sleeping $(( i * 20 ))s before retry..."
            sleep $(( i * 20 ))  # 20s、40s 的退避等待
          done
          echo "All attempts failed."
          exit 1

      - name: Commit snapshot if changed
        if: always()
        run: |
          if git status --porcelain | grep -q "snapshot.json"; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add snapshot.json
            git commit -m "chore: update snapshot.json [skip ci]"
            git push
          else
            echo "No snapshot changes."
          fi

      # 失败时打包日志/中间文件，方便排查
      - name: Upload logs & artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: monitor-logs
          path: |
            **/*.log
            new_map_partial.json
          if-no-files-found: ignore
